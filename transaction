/*
 * íŠ¸ëœì­ì…˜
 * ì—¬ëŸ¬ ê°œì˜ SQL ì‘ì—…ì„ í•˜ë‚˜ì˜ ë…¼ë¦¬ì ì¸ ë‹¨ìœ„ë¡œ ë¬¶ëŠ” ê²ƒ
 * ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•˜ë©´ ì ìš©(Commit), ì‹¤íŒ¨í•˜ë©´ ì·¨ì†Œ(Rollback)
 * ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥
 * 
 * íŠ¸ëœì­ì…˜ì˜ 4ê°€ì§€ íŠ¹ì„±(ê¸°ì‚¬ ì‹œí—˜ ë° ë©´ì ‘ ì¶œì œ)
 * Atomicity(ì›ìì„±) : íŠ¸ëœì­ì…˜ ë‚´ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•˜ê±°ë‚˜ ì‹¤íŒ¨í•´ì•¼ í•¨
 * Consistency(ì¼ê´€ì„±) : íŠ¸ëœì­ì…˜ ì í›„ ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ ì§€í•´ì•¼ í•¨
 * Isolation(ê²©ë¦¬ì„±) : ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” íŠ¸ëœì­ì…˜ ê°„ ì˜í–¥ ìµœì†Œí™”
 * Durability(ì§€ì†ì„±) : íŠ¸ëœì­ì…˜ì´ Commitì´ ë˜ë©´ ë°ì´í„°ê°€ ì˜êµ¬ ì €ì¥ë¨
 * 
 * ê²°ì œ(ê²°ì œ_id) -> ì£¼ë¬¸ì„œ ìƒì„±(ì£¼ë¬¸_id) -> ì£¼ë°© ë¹Œì§€ ìƒì„±(ë¹Œì§€_id)
 * */

/*
 * ëª¨ë“ˆ 2 : commit & Rollback
 * í•™ìƒì´ ê°•ì˜ë¥¼ ê²°ì œí–ˆì„ ë•Œ ê²°ì œ í…Œì´ë¸”(payments)ì™€ ìˆ˜ê°• ì‹ ì²­ í…Œì´ë¸”(enrollments)ë¥¼ ë™ì‹œì— ì—…ë°ì´íŠ¸í•œë‹¤.
 * ë§Œì•½ í•œìª½ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ì‘ì—…ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë ¤ì•¼ í•œë‹¤.
 * */

-- íŠ¸ëœì­ì…˜ ì‹œì‘
START TRANSACTION;
SELECT * FROM users WHERE user_id = "1001";
SELECT * FROM courses WHERE course_id = 1;

-- ê²°ì œ ë‚´ì—­ ì¶”ê°€
INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 1, 100.0, "pending");

-- ìˆ˜ê°• ì‹ ì²­ ì¶”ê°€
INSERT INTO enrollments(user_id, course_id, status)
VALUES (1001, 1, "active")

COMMIT;

SELECT * FROM payments WHERE user_id = "1001";
SELECT * FROM enrollments WHERE user_id = "1001";


/*
 * rollback(ì—ëŸ¬ ë°œìƒ ì‹œ ë˜ëŒë¦¬ê¸°)
 * */

START TRANSACTION

INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 1, 100.0, "pending");

-- ì˜¤ë¥˜ ë§Œë“¤ê¸°
-- INSERT INTO enrollments (user_id, course_id, status)
-- VALUES (1001, 9999999999, "active");

ROLLBACK;

/*
 * SAVEPOINT
 * íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ë¶€ë¶„ì ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆëŠ” í¬ì¸íŠ¸ë¥¼ ì„¤ì •
 * íŠ¹ì • ì§€ì ê¹Œì§€ë§Œ Rollback ê°€ëŠ¥ (savepoint ì´í›„ ì‹¤í–‰ëœ SQLë§Œ ì·¨ì†Œë¨)
 * */

START TRANSACTION;

INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 100, 100.0, "pending")
SAVEPOINT payments;

SELECT
	*
FROM payments
WHERE user_id = 1001;

-- ë‘ ë²ˆì§¸ ê²°ì œ
INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 999, 100.0, "pending")

-- ì„¸ ë²ˆì§¸ ê²°ì œ
INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 999, 100.0, "pending")

-- ë„¤ ë²ˆì§¸ ê²°ì œ
INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 999, 100.0, "pending")

-- ë‹¤ì„¯ ë²ˆì§¸ ê²°ì œ
INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1002, 999999999, 100.0, "pending")

-- ì¡°íšŒ
SELECT
	*
FROM payments
WHERE user_id = 1001;

ROLLBACK;
COMMIT;

ROLLBACK TO SAVEPOINT payments


/*       ë¯¸ì…˜        */

-- ğŸ“Œ ë‘ ê°œì˜ ê°•ì¢Œë¥¼ ê²°ì œí•œ í›„, ì²« ë²ˆì§¸ ê²°ì œë§Œ ìœ ì§€í•˜ê³  ë‘ ë²ˆì§¸ ê²°ì œëŠ” ì·¨ì†Œí•˜ì„¸ìš”.
START TRANSACTION;

INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 100, 100.0, "pending")
SAVEPOINT payments;

INSERT INTO payments(user_id, course_id, amount, payment_status)
VALUES (1001, 100, 100.0, "pending")
SAVEPOINT payments;

COMMIT;
ROLLBACK;

ROLLBACK TO SAVEPOINT payments
